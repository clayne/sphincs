#include "simpira.h"
#include <stdio.h>
#include <stdlib.h>

void simpira_testvectors() {
  unsigned char *in = (unsigned char *)calloc(64*8, sizeof(unsigned char));
  unsigned char *out256 = (unsigned char *)calloc(32*8, sizeof(unsigned char));
  unsigned char *out512 = (unsigned char *)calloc(64*8, sizeof(unsigned char));

  // Testvectors for all zero input for Simpira b=2 and b=4 taken from the
  // reference Implementation available at https://mouha.be/simpira/
  unsigned char testvector256[32] = {0x6b, 0x95, 0xca, 0x7d, 0x8c, 0xda, 0x46, 0xcf,
                                     0x97, 0xab, 0x44, 0x30, 0xa8, 0xef, 0x27, 0xc6,
                                     0x31, 0xb4, 0x64, 0xa6, 0xed, 0x10, 0x6a, 0x55,
                                     0x3e, 0x30, 0xa8, 0x3b, 0xa0, 0x8c, 0x14, 0xc2};

  unsigned char testvector512[32] = {0x08, 0x57, 0x27, 0xe5, 0xa0, 0x95, 0x56, 0x89,
                                     0x2f, 0x95, 0xf6, 0x29, 0xae, 0x53, 0x4b, 0xa1,
                                     0x83, 0x16, 0xac, 0x50, 0x1e, 0x85, 0xa4, 0xcf,
                                     0x1b, 0x57, 0x4e, 0x60, 0x5d, 0x1b, 0x21, 0x5e};

  int i;

  for(i = 0; i < 512; i++) {
    in[i] = 0;
  }

  simpira_f_8x(out256, in);
  simpira_h_8x(out512, in);

  // Verify output
  for(i = 0; i < 8*32; i++) {
    if (out256[i % 32] != testvector256[i % 32]) {
      printf("Error: testvector incorrect for simpira_f at position %i.\n", i);
      return;
    }
  }

  // Verify output
  for(i = 0; i < 8*32; i++) {
    if (out512[i % 32] != testvector512[i % 32]) {
      printf("Error: testvector incorrect for simpira_h at position %i.\n", i);
      return;
    }
  }
}

void simpira_f(unsigned char *out, const unsigned char *in) {
  u128 s[1][2], s_save[1][2], c;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);

  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];

  c = C(1, cB2);
  R(s[0][0],s[0][1], c);
  c = C(2, cB2);
  R(s[0][1],s[0][0], c);
  c = C(3, cB2);
  R(s[0][0],s[0][1], c);
  c = C(4, cB2);
  R(s[0][1],s[0][0], c);
  c = C(5, cB2);
  R(s[0][0],s[0][1], c);
  c = C(6, cB2);
  R(s[0][1],s[0][0], c);
  c = C(7, cB2);
  R(s[0][0],s[0][1], c);
  c = C(8, cB2);
  R(s[0][1],s[0][0], c);
  c = C(9, cB2);
  R(s[0][0],s[0][1], c);
  c = C(10, cB2);
  R(s[0][1],s[0][0], c);
  c = C(11, cB2);
  R(s[0][0],s[0][1], c);
  c = C(12, cB2);
  R(s[0][1],s[0][0], c);
  c = C(13, cB2);
  R(s[0][0],s[0][1], c);
  c = C(14, cB2);
  R(s[0][1],s[0][0], c);
  c = C(15, cB2);
  R(s[0][0],s[0][1], c);

  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
}


void simpira_f_4x(unsigned char *out, const unsigned char *in) {
  u128 s[4][2], s_save[4][2], c;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);
  s[1][0] = LOAD(in + 32);
  s[1][1] = LOAD(in + 48);
  s[2][0] = LOAD(in + 64);
  s[2][1] = LOAD(in + 80);
  s[3][0] = LOAD(in + 96);
  s[3][1] = LOAD(in + 112);

  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];
  s_save[1][0] = s[1][0];
  s_save[1][1] = s[1][1];
  s_save[2][0] = s[2][0];
  s_save[2][1] = s[2][1];
  s_save[3][0] = s[3][0];
  s_save[3][1] = s[3][1];

  c = C(1, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(2, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(3, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(4, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(5, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(6, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(7, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(8, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(9, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(10, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(11, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(12, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(13, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  c = C(14, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  c = C(15, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);

  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);
  s[1][0] = XOR(s[1][0], s_save[1][0]);
  s[1][1] = XOR(s[1][1], s_save[1][1]);
  s[2][0] = XOR(s[2][0], s_save[2][0]);
  s[2][1] = XOR(s[2][1], s_save[2][1]);
  s[3][0] = XOR(s[3][0], s_save[3][0]);
  s[3][1] = XOR(s[3][1], s_save[3][1]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
  STORE(out + 32, s[1][0]);
  STORE(out + 48, s[1][1]);
  STORE(out + 64, s[2][0]);
  STORE(out + 80, s[2][1]);
  STORE(out + 96, s[3][0]);
  STORE(out + 112, s[3][1]);
}


void simpira_f_8x(unsigned char *out, const unsigned char *in) {
  u128 s[8][2], s_save[8][2], c;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);
  s[1][0] = LOAD(in + 32);
  s[1][1] = LOAD(in + 48);
  s[2][0] = LOAD(in + 64);
  s[2][1] = LOAD(in + 80);
  s[3][0] = LOAD(in + 96);
  s[3][1] = LOAD(in + 112);
  s[4][0] = LOAD(in + 128);
  s[4][1] = LOAD(in + 144);
  s[5][0] = LOAD(in + 160);
  s[5][1] = LOAD(in + 176);
  s[6][0] = LOAD(in + 192);
  s[6][1] = LOAD(in + 208);
  s[7][0] = LOAD(in + 224);
  s[7][1] = LOAD(in + 240);

  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];
  s_save[1][0] = s[1][0];
  s_save[1][1] = s[1][1];
  s_save[2][0] = s[2][0];
  s_save[2][1] = s[2][1];
  s_save[3][0] = s[3][0];
  s_save[3][1] = s[3][1];
  s_save[4][0] = s[4][0];
  s_save[4][1] = s[4][1];
  s_save[5][0] = s[5][0];
  s_save[5][1] = s[5][1];
  s_save[6][0] = s[6][0];
  s_save[6][1] = s[6][1];
  s_save[7][0] = s[7][0];
  s_save[7][1] = s[7][1];

  c = C(1, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(2, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(3, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(4, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(5, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(6, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(7, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(8, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(9, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(10, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(11, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(12, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(13, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);
  c = C(14, cB2);
  R(s[0][1],s[0][0], c);
  R(s[1][1],s[1][0], c);
  R(s[2][1],s[2][0], c);
  R(s[3][1],s[3][0], c);
  R(s[4][1],s[4][0], c);
  R(s[5][1],s[5][0], c);
  R(s[6][1],s[6][0], c);
  R(s[7][1],s[7][0], c);
  c = C(15, cB2);
  R(s[0][0],s[0][1], c);
  R(s[1][0],s[1][1], c);
  R(s[2][0],s[2][1], c);
  R(s[3][0],s[3][1], c);
  R(s[4][0],s[4][1], c);
  R(s[5][0],s[5][1], c);
  R(s[6][0],s[6][1], c);
  R(s[7][0],s[7][1], c);

  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);
  s[1][0] = XOR(s[1][0], s_save[1][0]);
  s[1][1] = XOR(s[1][1], s_save[1][1]);
  s[2][0] = XOR(s[2][0], s_save[2][0]);
  s[2][1] = XOR(s[2][1], s_save[2][1]);
  s[3][0] = XOR(s[3][0], s_save[3][0]);
  s[3][1] = XOR(s[3][1], s_save[3][1]);
  s[4][0] = XOR(s[4][0], s_save[4][0]);
  s[4][1] = XOR(s[4][1], s_save[4][1]);
  s[5][0] = XOR(s[5][0], s_save[5][0]);
  s[5][1] = XOR(s[5][1], s_save[5][1]);
  s[6][0] = XOR(s[6][0], s_save[6][0]);
  s[6][1] = XOR(s[6][1], s_save[6][1]);
  s[7][0] = XOR(s[7][0], s_save[7][0]);
  s[7][1] = XOR(s[7][1], s_save[7][1]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
  STORE(out + 32, s[1][0]);
  STORE(out + 48, s[1][1]);
  STORE(out + 64, s[2][0]);
  STORE(out + 80, s[2][1]);
  STORE(out + 96, s[3][0]);
  STORE(out + 112, s[3][1]);
  STORE(out + 128, s[4][0]);
  STORE(out + 144, s[4][1]);
  STORE(out + 160, s[5][0]);
  STORE(out + 176, s[5][1]);
  STORE(out + 192, s[6][0]);
  STORE(out + 208, s[6][1]);
  STORE(out + 224, s[7][0]);
  STORE(out + 240, s[7][1]);
}


void simpira_h(unsigned char *out, const unsigned char *in) {
  u128 s[1][4], s_save[1][2], c0, c1;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);
  s[0][2] = LOAD(in + 32);
  s[0][3] = LOAD(in + 48);

  // Only need to store 256-bit as we will truncate later
  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];

  c0 = C(1, cB4);
  c1 = C(2, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  c0 = C(3, cB4);
  c1 = C(4, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  c0 = C(5, cB4);
  c1 = C(6, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  c0 = C(7, cB4);
  c1 = C(8, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  c0 = C(9, cB4);
  c1 = C(10, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  c0 = C(11, cB4);
  c1 = C(12, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  c0 = C(13, cB4);
  c1 = C(14, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  c0 = C(15, cB4);
  c1 = C(16, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  c0 = C(17, cB4);
  c1 = C(18, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  c0 = C(19, cB4);
  c1 = C(20, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  c0 = C(21, cB4);
  c1 = C(22, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  c0 = C(23, cB4);
  c1 = C(24, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  c0 = C(25, cB4);
  c1 = C(26, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  c0 = C(27, cB4);
  c1 = C(28, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  c0 = C(29, cB4);
  c1 = C(30, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);

  // Truncate output to 256-bit
  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
}


void simpira_h_4x(unsigned char *out, const unsigned char *in) {
  u128 s[4][4], s_save[4][2], c0, c1;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);
  s[0][2] = LOAD(in + 32);
  s[0][3] = LOAD(in + 48);
  s[1][0] = LOAD(in + 64);
  s[1][1] = LOAD(in + 80);
  s[1][2] = LOAD(in + 96);
  s[1][3] = LOAD(in + 112);
  s[2][0] = LOAD(in + 128);
  s[2][1] = LOAD(in + 144);
  s[2][2] = LOAD(in + 160);
  s[2][3] = LOAD(in + 176);
  s[3][0] = LOAD(in + 192);
  s[3][1] = LOAD(in + 208);
  s[3][2] = LOAD(in + 224);
  s[3][3] = LOAD(in + 240);

  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];
  s_save[1][0] = s[1][0];
  s_save[1][1] = s[1][1];
  s_save[2][0] = s[2][0];
  s_save[2][1] = s[2][1];
  s_save[3][0] = s[3][0];
  s_save[3][1] = s[3][1];

  c0 = C(1, cB4);
  c1 = C(2, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  c0 = C(3, cB4);
  c1 = C(4, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  c0 = C(5, cB4);
  c1 = C(6, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  c0 = C(7, cB4);
  c1 = C(8, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  c0 = C(9, cB4);
  c1 = C(10, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  c0 = C(11, cB4);
  c1 = C(12, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  c0 = C(13, cB4);
  c1 = C(14, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  c0 = C(15, cB4);
  c1 = C(16, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  c0 = C(17, cB4);
  c1 = C(18, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  c0 = C(19, cB4);
  c1 = C(20, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  c0 = C(21, cB4);
  c1 = C(22, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  c0 = C(23, cB4);
  c1 = C(24, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  c0 = C(25, cB4);
  c1 = C(26, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  c0 = C(27, cB4);
  c1 = C(28, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  c0 = C(29, cB4);
  c1 = C(30, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);

  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);
  s[0][1] = XOR(s[0][2], s_save[0][2]);
  s[0][1] = XOR(s[0][3], s_save[0][3]);
  s[1][0] = XOR(s[1][0], s_save[1][0]);
  s[1][1] = XOR(s[1][1], s_save[1][1]);
  s[1][1] = XOR(s[1][2], s_save[1][2]);
  s[1][1] = XOR(s[1][3], s_save[1][3]);
  s[2][0] = XOR(s[2][0], s_save[2][0]);
  s[2][1] = XOR(s[2][1], s_save[2][1]);
  s[2][1] = XOR(s[2][2], s_save[2][2]);
  s[2][1] = XOR(s[2][3], s_save[2][3]);
  s[3][0] = XOR(s[3][0], s_save[3][0]);
  s[3][1] = XOR(s[3][1], s_save[3][1]);
  s[3][1] = XOR(s[3][2], s_save[3][2]);
  s[3][1] = XOR(s[3][3], s_save[3][3]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
  STORE(out + 32, s[1][0]);
  STORE(out + 48, s[1][1]);
  STORE(out + 64, s[2][0]);
  STORE(out + 80, s[2][1]);
  STORE(out + 96, s[3][0]);
  STORE(out + 112, s[3][1]);
}


void simpira_h_8x(unsigned char *out, const unsigned char *in) {
  u128 s[8][4], s_save[8][2], c0, c1;
  s[0][0] = LOAD(in + 0);
  s[0][1] = LOAD(in + 16);
  s[0][2] = LOAD(in + 32);
  s[0][3] = LOAD(in + 48);
  s[1][0] = LOAD(in + 64);
  s[1][1] = LOAD(in + 80);
  s[1][2] = LOAD(in + 96);
  s[1][3] = LOAD(in + 112);
  s[2][0] = LOAD(in + 128);
  s[2][1] = LOAD(in + 144);
  s[2][2] = LOAD(in + 160);
  s[2][3] = LOAD(in + 176);
  s[3][0] = LOAD(in + 192);
  s[3][1] = LOAD(in + 208);
  s[3][2] = LOAD(in + 224);
  s[3][3] = LOAD(in + 240);
  s[4][0] = LOAD(in + 256);
  s[4][1] = LOAD(in + 272);
  s[4][2] = LOAD(in + 288);
  s[4][3] = LOAD(in + 304);
  s[5][0] = LOAD(in + 320);
  s[5][1] = LOAD(in + 336);
  s[5][2] = LOAD(in + 352);
  s[5][3] = LOAD(in + 368);
  s[6][0] = LOAD(in + 384);
  s[6][1] = LOAD(in + 400);
  s[6][2] = LOAD(in + 416);
  s[6][3] = LOAD(in + 432);
  s[7][0] = LOAD(in + 448);
  s[7][1] = LOAD(in + 464);
  s[7][2] = LOAD(in + 480);
  s[7][3] = LOAD(in + 496);

  s_save[0][0] = s[0][0];
  s_save[0][1] = s[0][1];
  s_save[1][0] = s[1][0];
  s_save[1][1] = s[1][1];
  s_save[2][0] = s[2][0];
  s_save[2][1] = s[2][1];
  s_save[3][0] = s[3][0];
  s_save[3][1] = s[3][1];
  s_save[4][0] = s[4][0];
  s_save[4][1] = s[4][1];
  s_save[5][0] = s[5][0];
  s_save[5][1] = s[5][1];
  s_save[6][0] = s[6][0];
  s_save[6][1] = s[6][1];
  s_save[7][0] = s[7][0];
  s_save[7][1] = s[7][1];

  c0 = C(1, cB4);
  c1 = C(2, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  R4(s[4][0],s[4][1], s[4][2], s[4][3], c0, c1);
  R4(s[5][0],s[5][1], s[5][2], s[5][3], c0, c1);
  R4(s[6][0],s[6][1], s[6][2], s[6][3], c0, c1);
  R4(s[7][0],s[7][1], s[7][2], s[7][3], c0, c1);
  c0 = C(3, cB4);
  c1 = C(4, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  R4(s[4][1],s[4][2], s[4][3], s[4][0], c0, c1);
  R4(s[5][1],s[5][2], s[5][3], s[5][0], c0, c1);
  R4(s[6][1],s[6][2], s[6][3], s[6][0], c0, c1);
  R4(s[7][1],s[7][2], s[7][3], s[7][0], c0, c1);
  c0 = C(5, cB4);
  c1 = C(6, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  R4(s[4][2],s[4][3], s[4][0], s[4][1], c0, c1);
  R4(s[5][2],s[5][3], s[5][0], s[5][1], c0, c1);
  R4(s[6][2],s[6][3], s[6][0], s[6][1], c0, c1);
  R4(s[7][2],s[7][3], s[7][0], s[7][1], c0, c1);
  c0 = C(7, cB4);
  c1 = C(8, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  R4(s[4][3],s[4][0], s[4][1], s[4][2], c0, c1);
  R4(s[5][3],s[5][0], s[5][1], s[5][2], c0, c1);
  R4(s[6][3],s[6][0], s[6][1], s[6][2], c0, c1);
  R4(s[7][3],s[7][0], s[7][1], s[7][2], c0, c1);
  c0 = C(9, cB4);
  c1 = C(10, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  R4(s[4][0],s[4][1], s[4][2], s[4][3], c0, c1);
  R4(s[5][0],s[5][1], s[5][2], s[5][3], c0, c1);
  R4(s[6][0],s[6][1], s[6][2], s[6][3], c0, c1);
  R4(s[7][0],s[7][1], s[7][2], s[7][3], c0, c1);
  c0 = C(11, cB4);
  c1 = C(12, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  R4(s[4][1],s[4][2], s[4][3], s[4][0], c0, c1);
  R4(s[5][1],s[5][2], s[5][3], s[5][0], c0, c1);
  R4(s[6][1],s[6][2], s[6][3], s[6][0], c0, c1);
  R4(s[7][1],s[7][2], s[7][3], s[7][0], c0, c1);
  c0 = C(13, cB4);
  c1 = C(14, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  R4(s[4][2],s[4][3], s[4][0], s[4][1], c0, c1);
  R4(s[5][2],s[5][3], s[5][0], s[5][1], c0, c1);
  R4(s[6][2],s[6][3], s[6][0], s[6][1], c0, c1);
  R4(s[7][2],s[7][3], s[7][0], s[7][1], c0, c1);
  c0 = C(15, cB4);
  c1 = C(16, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  R4(s[4][3],s[4][0], s[4][1], s[4][2], c0, c1);
  R4(s[5][3],s[5][0], s[5][1], s[5][2], c0, c1);
  R4(s[6][3],s[6][0], s[6][1], s[6][2], c0, c1);
  R4(s[7][3],s[7][0], s[7][1], s[7][2], c0, c1);
  c0 = C(17, cB4);
  c1 = C(18, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  R4(s[4][0],s[4][1], s[4][2], s[4][3], c0, c1);
  R4(s[5][0],s[5][1], s[5][2], s[5][3], c0, c1);
  R4(s[6][0],s[6][1], s[6][2], s[6][3], c0, c1);
  R4(s[7][0],s[7][1], s[7][2], s[7][3], c0, c1);
  c0 = C(19, cB4);
  c1 = C(20, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  R4(s[4][1],s[4][2], s[4][3], s[4][0], c0, c1);
  R4(s[5][1],s[5][2], s[5][3], s[5][0], c0, c1);
  R4(s[6][1],s[6][2], s[6][3], s[6][0], c0, c1);
  R4(s[7][1],s[7][2], s[7][3], s[7][0], c0, c1);
  c0 = C(21, cB4);
  c1 = C(22, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  R4(s[4][2],s[4][3], s[4][0], s[4][1], c0, c1);
  R4(s[5][2],s[5][3], s[5][0], s[5][1], c0, c1);
  R4(s[6][2],s[6][3], s[6][0], s[6][1], c0, c1);
  R4(s[7][2],s[7][3], s[7][0], s[7][1], c0, c1);
  c0 = C(23, cB4);
  c1 = C(24, cB4);
  R4(s[0][3],s[0][0], s[0][1], s[0][2], c0, c1);
  R4(s[1][3],s[1][0], s[1][1], s[1][2], c0, c1);
  R4(s[2][3],s[2][0], s[2][1], s[2][2], c0, c1);
  R4(s[3][3],s[3][0], s[3][1], s[3][2], c0, c1);
  R4(s[4][3],s[4][0], s[4][1], s[4][2], c0, c1);
  R4(s[5][3],s[5][0], s[5][1], s[5][2], c0, c1);
  R4(s[6][3],s[6][0], s[6][1], s[6][2], c0, c1);
  R4(s[7][3],s[7][0], s[7][1], s[7][2], c0, c1);
  c0 = C(25, cB4);
  c1 = C(26, cB4);
  R4(s[0][0],s[0][1], s[0][2], s[0][3], c0, c1);
  R4(s[1][0],s[1][1], s[1][2], s[1][3], c0, c1);
  R4(s[2][0],s[2][1], s[2][2], s[2][3], c0, c1);
  R4(s[3][0],s[3][1], s[3][2], s[3][3], c0, c1);
  R4(s[4][0],s[4][1], s[4][2], s[4][3], c0, c1);
  R4(s[5][0],s[5][1], s[5][2], s[5][3], c0, c1);
  R4(s[6][0],s[6][1], s[6][2], s[6][3], c0, c1);
  R4(s[7][0],s[7][1], s[7][2], s[7][3], c0, c1);
  c0 = C(27, cB4);
  c1 = C(28, cB4);
  R4(s[0][1],s[0][2], s[0][3], s[0][0], c0, c1);
  R4(s[1][1],s[1][2], s[1][3], s[1][0], c0, c1);
  R4(s[2][1],s[2][2], s[2][3], s[2][0], c0, c1);
  R4(s[3][1],s[3][2], s[3][3], s[3][0], c0, c1);
  R4(s[4][1],s[4][2], s[4][3], s[4][0], c0, c1);
  R4(s[5][1],s[5][2], s[5][3], s[5][0], c0, c1);
  R4(s[6][1],s[6][2], s[6][3], s[6][0], c0, c1);
  R4(s[7][1],s[7][2], s[7][3], s[7][0], c0, c1);
  c0 = C(29, cB4);
  c1 = C(30, cB4);
  R4(s[0][2],s[0][3], s[0][0], s[0][1], c0, c1);
  R4(s[1][2],s[1][3], s[1][0], s[1][1], c0, c1);
  R4(s[2][2],s[2][3], s[2][0], s[2][1], c0, c1);
  R4(s[3][2],s[3][3], s[3][0], s[3][1], c0, c1);
  R4(s[4][2],s[4][3], s[4][0], s[4][1], c0, c1);
  R4(s[5][2],s[5][3], s[5][0], s[5][1], c0, c1);
  R4(s[6][2],s[6][3], s[6][0], s[6][1], c0, c1);
  R4(s[7][2],s[7][3], s[7][0], s[7][1], c0, c1);

  s[0][0] = XOR(s[0][0], s_save[0][0]);
  s[0][1] = XOR(s[0][1], s_save[0][1]);
  s[1][0] = XOR(s[1][0], s_save[1][0]);
  s[1][1] = XOR(s[1][1], s_save[1][1]);
  s[2][0] = XOR(s[2][0], s_save[2][0]);
  s[2][1] = XOR(s[2][1], s_save[2][1]);
  s[3][0] = XOR(s[3][0], s_save[3][0]);
  s[3][1] = XOR(s[3][1], s_save[3][1]);
  s[4][0] = XOR(s[4][0], s_save[4][0]);
  s[4][1] = XOR(s[4][1], s_save[4][1]);
  s[5][0] = XOR(s[5][0], s_save[5][0]);
  s[5][1] = XOR(s[5][1], s_save[5][1]);
  s[6][0] = XOR(s[6][0], s_save[6][0]);
  s[6][1] = XOR(s[6][1], s_save[6][1]);
  s[7][0] = XOR(s[7][0], s_save[7][0]);
  s[7][1] = XOR(s[7][1], s_save[7][1]);

  STORE(out + 0, s[0][0]);
  STORE(out + 16, s[0][1]);
  STORE(out + 32, s[1][0]);
  STORE(out + 48, s[1][1]);
  STORE(out + 64, s[2][0]);
  STORE(out + 80, s[2][1]);
  STORE(out + 96, s[3][0]);
  STORE(out + 112, s[3][1]);
  STORE(out + 128, s[4][0]);
  STORE(out + 144, s[4][1]);
  STORE(out + 160, s[5][0]);
  STORE(out + 176, s[5][1]);
  STORE(out + 192, s[6][0]);
  STORE(out + 208, s[6][1]);
  STORE(out + 224, s[7][0]);
  STORE(out + 240, s[7][1]);
}
